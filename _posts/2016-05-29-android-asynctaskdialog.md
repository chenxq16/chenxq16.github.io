---
layout: post
title:  AsyncTaskDialog简述
date:   2016-05-29 12:55:11
tags:
    - android
---

简化在处理异步任务的时候与dialog的交互过程。第一个开源项目需要支持一下哈！！！

---

### 源由

相信有一个即简单、有麻烦的场景大家在开发android应用程序的时候会经常遇到。譬如在请求网络的时候，我们首先会显示一个loading对话框，接着异步线程请求网络等待网络响应，最后处理返回结果关闭对话框。本文就是着力于这么一个简单的场景，介绍一下自己的想法，并推广一下自己写的第一个开源项目[AsyncTaskDialog][1]。有什么地方写的不好的、有问题的还望大家海涵，并指出修正。谢谢！

### 关于名字

AsyncTaskDialog，它不是一个dialog，它设计的初衷是让人们在处理耗时任务的时候，无需理会loading框的显示与关闭，全部帮你在SDK里完成。正是因为设计它的初衷只是为了解决这一个问题，所以没有太多考虑其它场景。有疑问或者需求可以留言给我，或者可以fork项目自己实现。这里只讨论一些简单的设计，并无太多代码实现。

### 一些设计

#### 需求剖析

一般的应用程序访问网络的过程就像上面所说的：1.打开对话框、2.处理一个或者多个网络请求、3.处理响应通知UI线程刷新、4.关闭对话框，这4个步骤。这样简单的一抽象，基本的需求就出来了。其中第二点需要考虑一下，多个异步任务之间可能会存在处理的先后顺序。

#### 粗略介绍

如上面所说，这不是一个dialog，我们也不知道用户dialog的样式，所以关于dialog我们不定义，由外面定义好后，传入进来，灵活方便。我们侧重如何处理异步任务之间的调度关系，来操作dialog。

首先我们清楚，异步任务通常是跑在子线程中，而线程结束后通常又是需要在UI线程里去刷新页面。所以我们的抽象类Task，应该至少包含两个方法，doInBackgroud()、doneInUI()，而且也是这么做的。

通过上面的需求剖析，我们清楚应该由两个处理方式不同的异步任务类型。一种是具有先后顺序的异步任务，处理完任务A，再处理任务B，最后关闭对话框等。第二种是具有竞争关系的，任务A与任务B可以同时处理，谁处理的慢，谁就负责关闭对话框。所以这里至少应该由2种不同的集合类型来管理这些不同的任务，至少说对于第一种我们都知道他应该是一种队列的行为（FIFO）。在Java里很快就可以想到Queue及其子类（这里不作过多介绍），考虑到线程安全及只是简单点存、取操作，我们选用ArrayBlockingQueue作为我们的实现。而竞争关系的集合类型，可以由我们自己控制，考虑到线程安全我们选用Vector。

至此基本上差不多了，但为了便于管理。我们细想一下，上面的集合类型在处理后台耗时任务的时候，可以统一管理，但一旦结束该耗时任务进入到UI线程中，我们就没法追踪各个任务了。所以我们需要一个新的集合将处理完的task，统一管理起来，而这个集合类型负责task在UI中的处理。

所以整个程序的核心就是这几个集合类。

loop: taskBackground、queue，后台任务执行完毕后从taskBackgroud、queue中移除，添加到taskUI中，并触发loop:taskUI。

最后，destory回收资源。

项目源码托管在github上：[AsyncTaskDialog][1]

enjoy it！

  [1]: https://github.com/chenxq16/AsyncTaskDialog
